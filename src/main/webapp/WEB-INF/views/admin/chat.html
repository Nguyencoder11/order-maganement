<!-- Trang hien thi danh sach cac nguoi dung va tin nhan moi nhat -->
<div th:fragment="content" class="chat-fragment">
    <h1 class="chat-title">Danh sách tin nhắn</h1>
    <div class="chat-item" th:attr="data-username=${user.username}" th:each="user : ${listUsers}"
         th:onclick="'window.location.href=\'/admin/chat/user/' + ${user.userId} + '\''">
        <div class="chat-avatar">
            <img th:src="${user.imagePath}"
                 alt="avatar">
        </div>
        <div class="chat-info">
            <strong th:text="${user.username}"></strong>
            <p th:text="${user.lastMessage}"
                th:classappend="${user.hasUnread} ? ' font-bold' : ''"></p>
        </div>
    </div>

    <script>
        let stompClient = null

        function connectForChatList() {
            const socket = new SockJS("/ws-chat")
            stompClient = Stomp.over(socket)

            stompClient.connect({username: 'admin'}, (frame) => {
                console.log('Connected to WS for chat list: ' + frame)

                stompClient.subscribe("/topic/chat-list-update", (message) => {
                    const updatedUser = JSON.parse(message.body)
                    console.log("Received updated users:", updatedUser)
                    const container = document.querySelector('.chat-fragment')
                    container.innerHTML = ''

                    updatedUser.forEach(user => {
                        const div = document.createElement('div')
                        div.className = 'chat-item'
                        if (user.hasUnread) div.classList.add('unread')

                        div.setAttribute('data-username', user.username)
                        div.onclick = () => {
                            window.location.href = '/admin/chat/user/' + user.userId
                        }

                        div.innerHTML = `
                            <div class="chat-avatar"><img src="${user.imagePath}" alt="avatar"></div>
                            <div class="chat-info">
                                <strong>${user.username}</strong>
                                <p>${user.lastMessage}</p>
                            </div>
                        `
                        container.appendChild(div)
                    })
                })
            })
        }
    </script>
</div>