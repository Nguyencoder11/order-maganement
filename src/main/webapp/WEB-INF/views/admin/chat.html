<!-- Trang hien thi danh sach cac nguoi dung va tin nhan moi nhat -->
<div th:fragment="content" class="chat-fragment">
    <h1 class="chat-title">Danh sách tin nhắn</h1>
    <div class="chat-item" th:attr="data-username=${user.username}" th:each="user : ${listUsers}"
         th:onclick="'window.location.href=\'/admin/chat/user/' + ${user.userId} + '\''">
        <div class="chat-avatar">
            <img th:src="${user.imagePath}"
                 alt="avatar">
        </div>
        <div class="chat-info">
            <strong th:text="${user.username}"></strong>
            <p th:text="${user.lastMessage}"
                th:classappend="${user.hasUnread} ? ' font-bold' : ''"></p>
        </div>
    </div>

    <script>
        let stompClient = null

        function updateChatList(message) {
            console.log("=== RECEIVED CHAT LIST UPDATE ===")
            console.log("Raw message:", message.body)
            
            const updatedUser = JSON.parse(message.body)
            console.log("Parsed users:", updatedUser)
            console.log("Number of users:", updatedUser.length)
            
            // Debug: In ra thông tin tin nhắn chưa đọc
            updatedUser.forEach(user => {
                if (user.hasUnread) {
                    console.log("UNREAD MESSAGE from " + user.username + ": " + user.lastMessage)
                }
            })
            
            const container = document.querySelector('.chat-fragment')
            container.innerHTML = ''
            
            // Thêm lại tiêu đề
            const titleDiv = document.createElement('h1')
            titleDiv.className = 'chat-title'
            titleDiv.textContent = 'Danh sách tin nhắn'
            container.appendChild(titleDiv)

            updatedUser.forEach(user => {
                const div = document.createElement('div')
                div.className = 'chat-item'
                if (user.hasUnread) div.classList.add('unread')

                div.setAttribute('data-username', user.username)
                div.onclick = () => {
                    window.location.href = '/admin/chat/user/' + user.userId
                }

                // Tạo message hiển thị với style phù hợp
                const messageClass = user.hasUnread ? 'font-bold' : ''
                
                div.innerHTML = `
                    <div class="chat-avatar"><img src="${user.imagePath}" alt="avatar"></div>
                    <div class="chat-info">
                        <strong>${user.username}</strong>
                        <p class="${messageClass}">${user.lastMessage}</p>
                    </div>
                `
                container.appendChild(div)
            })
        }

        function connectForChatList() {
            const socket = new SockJS("/ws-chat")
            stompClient = Stomp.over(socket)

            stompClient.connect({username: 'admin'}, (frame) => {
                console.log('=== WEBSOCKET CONNECTED ===')
                console.log('Frame:', frame)

                // Subscribe topic chung cho tất cả admin
                stompClient.subscribe("/topic/chat-list-update", (message) => {
                    console.log("=== RECEIVED MESSAGE ON /topic/chat-list-update ===")
                    updateChatList(message)
                })
                
                // Subscribe user destination cho admin cụ thể
                stompClient.subscribe("/user/queue/chat-list-update", (message) => {
                    console.log("=== RECEIVED MESSAGE ON /user/queue/chat-list-update ===")
                    updateChatList(message)
                })
                
                // Subscribe topic mới cho admin
                stompClient.subscribe("/topic/admin-chat-update", (message) => {
                    console.log("=== RECEIVED MESSAGE ON /topic/admin-chat-update ===")
                    updateChatList(message)
                })
                
                console.log('=== ALL SUBSCRIPTIONS SET UP ===')
            }, (error) => {
                console.error('=== WEBSOCKET CONNECTION ERROR ===', error)
                // Thử kết nối lại sau 3 giây
                setTimeout(() => {
                    console.log('Attempting to reconnect...')
                    connectForChatList()
                }, 3000)
            })
        }
        
        // Đợi thư viện load xong rồi mới gọi function connect
        window.addEventListener('load', function() {
            // Kiểm tra xem SockJS đã load chưa
            if (typeof SockJS !== 'undefined' && typeof Stomp !== 'undefined') {
                console.log('Libraries loaded, connecting...')
                connectForChatList()
            } else {
                console.error('SockJS or Stomp not loaded')
                // Thử lại sau 1 giây
                setTimeout(() => {
                    if (typeof SockJS !== 'undefined' && typeof Stomp !== 'undefined') {
                        console.log('Libraries loaded on retry, connecting...')
                        connectForChatList()
                    } else {
                        console.error('Still cannot load libraries')
                    }
                }, 1000)
            }
        })
    </script>
</div>